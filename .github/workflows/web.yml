name: Deploy to Remote Server

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 14

    - name: Install Dependencies
      working-directory: ./BassLines.Web
      run: yarn install

    - name: Run Yarn Command
      working-directory: ./BassLines.Web
      run: yarn prod:webpack

    - name: Zip Directory
      working-directory: ./BassLines.Web/dist
      run: zip -r basslines.web.${{github.run_number}}.zip ./

    - name: Upload Artifact
      uses: actions/upload-artifact@v2
      with:
        name: basslines.web.${{github.run_number}}
        path: ./BassLines.Web/dist/basslines.web.${{github.run_number}}.zip

  approve:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Wait for Approval
        uses: actions/wait-for-approval@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          # Timeout in minutes (default is 10 minutes)
          timeout-minutes: 5

  deploy_remote:
    needs: approve
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v2
        with:
          name: basslines.web.${{github.run_number}}
          path: .

      - name: Create SSH File
        run: touch ~/.ssh/id_rsa

      - name: Install SSH Key
        run: echo "$LIGHTSAIL_SSH_KEY" > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa

      - name: Copy Artifact to Remote Server
        run: scp -o StrictHostKeyChecking=no -r basslines.web.${{github.run_number}}.zip ec2-user@alexanderdev.com:/appl/app.web.basslines.co
